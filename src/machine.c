#include <machine.h>
#include <stdlib.h>
#include <string.h>
#include <decode.h>

#define N_REGS 16
#define STACK_DEPTH 24
#define DIGIT_SPRITE_HEIGHT 5

uint8_t *disp;
uint16_t keys;
uint8_t mem[MEM_SIZE];
uint8_t regs[N_REGS];
uint16_t addr_reg;
uint16_t stack[STACK_DEPTH];
uint8_t delay_timer, sound_timer;
uint16_t pc;
int sp;

uint8_t * const vf = &regs[0xF];

const uint8_t digit_sprites[16][DIGIT_SPRITE_HEIGHT] = {
    {0xF0, 0x90, 0x90, 0x90, 0xF0},
    {0x20, 0x60, 0x20, 0x20, 0x70},
    {0xF0, 0x10, 0xF0, 0x80, 0xF0},
    {0xF0, 0x10, 0xF0, 0x10, 0xF0},
    {0x90, 0x90, 0xF0, 0x10, 0x10},
    {0xF0, 0x80, 0xF0, 0x10, 0xF0},
    {0xF0, 0x80, 0xF0, 0x90, 0xF0},
    {0xF0, 0x10, 0x20, 0x40, 0x40},
    {0xF0, 0x90, 0xF0, 0x90, 0xF0},
    {0xF0, 0x90, 0xF0, 0x10, 0xF0},
    {0xF0, 0x90, 0xF0, 0x90, 0x90},
    {0xE0, 0x90, 0xE0, 0x90, 0xE0},
    {0xF0, 0x80, 0x80, 0x80, 0xF0},
    {0xE0, 0x90, 0x90, 0x90, 0xE0},
    {0xF0, 0x80, 0xF0, 0x80, 0xF0},
    {0xF0, 0x80, 0xF0, 0x80, 0x80}
};

void init_machine(void)
{
    disp = malloc(DISP_SIZE);
    for(size_t i = 0; i < DISP_SIZE; i++){
        disp[i] = 0;
    }

    keys = 0;
    delay_timer = 0;
    sound_timer = 0;
    pc = PROG_START_ADDR;
    sp = -1;

    memcpy(mem + SPRITE_START_ADDR, digit_sprites, 16*DIGIT_SPRITE_HEIGHT);
}

void perform_cycle(void)
{
    fetch_and_decode();
    exec_fun();
}

void decr_timers(void)
{
    if(delay_timer) delay_timer--;
    if(sound_timer) sound_timer--;
}
